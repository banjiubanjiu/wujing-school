<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>警院教务中心 · P0/P1 MVP</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --panel: #ffffff;
        --border: #e6e8ec;
        --text: #1e2a3b;
        --muted: #6e7c91;
        --accent: #0f5ae0;
        --accent-2: #17b39b;
        --shadow: 0 14px 40px rgba(15, 90, 224, 0.08);
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Source Sans Pro", "Noto Sans SC", "Microsoft YaHei", sans-serif;
      }

      a {
        color: var(--accent);
      }

      .hidden {
        display: none !important;
      }

      /* 登录遮罩 */
      #login-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 10% 20%, rgba(15, 90, 224, 0.08), transparent 20%),
          radial-gradient(circle at 80% 10%, rgba(23, 179, 155, 0.12), transparent 25%),
          var(--bg);
        padding: 24px;
      }

      .login-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 32px;
        max-width: 820px;
        width: 100%;
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 28px;
      }

      .login-card h1 {
        margin: 0 0 8px;
        font-size: 24px;
        font-weight: 800;
      }

      .pill {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(15, 90, 224, 0.08);
        color: var(--accent);
        font-size: 12px;
        font-weight: 700;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      form {
        display: grid;
        gap: 12px;
      }

      input,
      button {
        font: inherit;
      }

      input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fafbfe;
      }

      input:focus {
        outline: 2px solid rgba(15, 90, 224, 0.18);
        border-color: rgba(15, 90, 224, 0.3);
      }

      button {
        border: none;
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.15s ease;
      }

      .btn-primary {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 10px 20px rgba(15, 90, 224, 0.18);
      }

      .btn-ghost {
        background: #f2f4f8;
        color: var(--text);
        border: 1px solid var(--border);
      }

      button:hover {
        transform: translateY(-1px);
      }

      /* 应用布局 */
      #app-shell {
        min-height: 100vh;
      }

      .topbar {
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        background: #0c2340;
        color: #f3f6fb;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: 0.5px;
      }

      .brand-badge {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, #0f5ae0, #17b39b);
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 900;
      }

      .user-chip {
        padding: 8px 12px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.12);
        font-size: 13px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .shell-body {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: calc(100vh - 64px);
      }

      .sidebar {
        background: #ffffff;
        border-right: 1px solid var(--border);
        padding: 18px 16px;
      }

      .nav-title {
        font-weight: 700;
        margin-bottom: 12px;
        color: #0f5ae0;
      }

      .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
      }

      .nav-item {
        padding: 10px 12px;
        border-radius: 10px;
        color: var(--text);
        border: 1px solid var(--border);
        background: #fbfcff;
        font-size: 14px;
      }

      .nav-item .hint {
        color: var(--muted);
        font-size: 12px;
      }

      .content {
        padding: 24px;
        display: grid;
        gap: 16px;
      }

      .hero {
        background: linear-gradient(120deg, rgba(15, 90, 224, 0.12), rgba(23, 179, 155, 0.08));
        border: 1px solid rgba(15, 90, 224, 0.08);
        border-radius: var(--radius);
        padding: 18px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .hero h2 {
        margin: 0 0 6px;
        font-size: 20px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px 18px;
      }

      .panel-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        font-weight: 800;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .kpi {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fbfcff;
      }

      .kpi .label {
        color: var(--muted);
        font-size: 13px;
      }

      .kpi .value {
        font-size: 28px;
        font-weight: 800;
        margin-top: 6px;
        color: var(--accent);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
      }

      th {
        color: var(--muted);
        font-weight: 700;
      }

      .tag {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
      }

      .tag-green {
        background: rgba(23, 179, 155, 0.12);
        color: #0f8b7b;
      }

      .tag-amber {
        background: rgba(255, 184, 53, 0.16);
        color: #c36a00;
      }

      .quick-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .quick-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fbfcff;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .quick-card:hover {
        border-color: var(--accent);
        box-shadow: 0 12px 24px rgba(15, 90, 224, 0.12);
      }

      .section-note {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 8px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }

      .form-field {
        display: grid;
        gap: 6px;
      }

      .form-field label {
        font-size: 13px;
        color: var(--muted);
      }

      textarea {
        width: 100%;
        min-height: 90px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fafbfe;
        font: inherit;
      }

      @media (max-width: 980px) {
        .shell-body {
          grid-template-columns: 1fr;
        }
        .sidebar {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <div class="login-card">
        <div>
          <div class="pill">警院教务中心 · P0/P1</div>
          <h1>统一登录</h1>
          <div class="muted">使用不同账号体验学生 / 教师 / 教务角色。</div>
          <form id="login-form" style="margin-top: 14px">
            <input id="username" placeholder="用户名：admin / teacher1 / student1" />
            <input id="password" placeholder="密码" type="password" />
            <div style="display: flex; gap: 12px; align-items: center; justify-content: center;">
              <button class="btn-primary" type="submit" style="min-width: 140px; padding: 14px 18px; font-size: 15px;">登录</button>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px; justify-content: center; flex-wrap: wrap;">
              <button class="btn-ghost" type="button" id="fill-student" style="min-width: 110px; padding: 10px 12px;">student1</button>
              <button class="btn-ghost" type="button" id="fill-teacher" style="min-width: 110px; padding: 10px 12px;">teacher1</button>
              <button class="btn-ghost" type="button" id="fill-admin" style="white-space: nowrap; min-width: 110px; padding: 10px 12px;">admin</button>
            </div>
            <div id="login-status" class="muted"></div>
          </form>
        </div>
        <div>
          <div class="pill" style="background: rgba(23,179,155,0.12); color:#0f8b7b;">当前能力</div>
          <ul class="muted" style="line-height: 1.6; margin-top: 10px;">
            <li>账号/角色/菜单（P0）</li>
            <li>学籍、课程、培养方案（P1）</li>
            <li>排课与课表、成绩录入/发布（P1）</li>
          </ul>
          <div class="muted" style="margin-top: 16px;">演示账号密码均为“账号+123”。</div>
        </div>
      </div>
    </div>

    <div id="app-shell" class="hidden">
      <header class="topbar">
        <div class="brand">
          <div class="brand-badge">PA</div>
          <div>
            <div style="font-size: 16px; font-weight: 800;">警院教务中心</div>
            <div style="font-size: 12px; color: #c9d6ea;">Academic & Training Portal</div>
          </div>
        </div>
        <div class="user-chip" id="user-chip">
          <span id="welcome-roles-top"></span>
          <button id="logout-btn" class="btn-ghost" style="padding:6px 10px;">退出</button>
        </div>
      </header>
      <div class="shell-body">
        <aside class="sidebar">
          <div class="nav-title">常用导航</div>
          <ul class="nav-list" id="sidebar-menu">
            <li class="nav-item">
              首页看板
              <div class="hint">核心数据 / 待办</div>
            </li>
            <li class="nav-item">
              学籍与班级
              <div class="hint">导入/查询学籍</div>
            </li>
            <li class="nav-item">
              课程与教学班
              <div class="hint">排课 / 课表</div>
            </li>
            <li class="nav-item">
              成绩与发布
              <div class="hint">录入 / 审核 / 查看</div>
            </li>
          </ul>
        </aside>
        <main class="content">
          <section class="hero">
            <div>
              <h2 id="welcome-title">欢迎</h2>
              <div class="muted" id="welcome-roles"></div>
            </div>
            <div class="muted">演示数据已预置，可直接体验课表、成绩、方案。</div>
          </section>

          <section class="panel">
            <div class="panel-head">
              <span>核心数据概览</span>
            </div>
            <div id="kpi-grid" class="kpi-grid"></div>
          </section>

          <div class="grid-2">
            <section class="panel">
              <div class="panel-head">
                <span>近期课表</span>
              </div>
              <div id="schedule-preview" class="muted">暂无课表</div>
            </section>
            <section class="panel">
              <div class="panel-head">
                <span>角色快捷入口</span>
              </div>
              <div id="menu-quick" class="quick-cards"></div>
            </section>
          </div>

          <section id="student-block" class="panel hidden">
            <div class="panel-head">
              <span>学生视角</span>
              <span class="muted">我的课表与成绩</span>
            </div>
            <div class="grid-2">
              <div>
                <div class="section-note">我的课表</div>
                <div id="student-schedule" class="muted">加载中...</div>
              </div>
              <div>
                <div class="section-note">我的成绩</div>
                <div id="student-grades" class="muted">加载中...</div>
              </div>
            </div>
          </section>

          <section id="teacher-block" class="panel hidden">
            <div class="panel-head">
              <span>教师视角</span>
              <span class="muted">授课安排与课程</span>
            </div>
            <div class="grid-2">
              <div>
                <div class="section-note">授课安排</div>
                <div id="teacher-schedule" class="muted">加载中...</div>
              </div>
              <div>
                <div class="section-note">课程列表（演示）</div>
                <div id="teacher-grades" class="muted">加载中...</div>
              </div>
            </div>
          </section>

          <section id="admin-block" class="panel hidden">
            <div class="panel-head">
              <span>教务视角</span>
              <span class="muted">学籍与培养方案</span>
            </div>
            <div class="grid-2">
              <div>
                <div class="section-note">学籍快览</div>
                <div id="admin-students" class="muted">加载中...</div>
              </div>
              <div>
                <div class="section-note">培养方案</div>
                <div id="admin-plans" class="muted">加载中...</div>
              </div>
            </div>
            <div style="margin-top: 16px;">
              <div class="panel-head">
                <span>教务操作</span>
                <span class="muted">导入 / 新增 / 排课 / 方案</span>
              </div>
              <div class="grid-2">
                <div class="panel" style="box-shadow:none; border-style:dashed;">
                  <div class="section-note">学籍导入（JSON 列表）</div>
                  <textarea id="import-students-input" placeholder='[{"username":"s100","password":"pass","full_name":"学生","student_no":"2024100","class_id":1}]'></textarea>
                  <button class="btn-primary" id="import-students-btn" style="margin-top:8px;">导入学籍</button>
                  <div id="import-students-status" class="muted"></div>
                </div>
                <div class="panel" style="box-shadow:none; border-style:dashed;">
                  <div class="section-note">新建班级 / 课程</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>班级</label>
                      <input id="class-code" placeholder="班级编码" />
                      <input id="class-name" placeholder="班级名称" />
                      <input id="class-major" placeholder="major_id" />
                      <input id="class-term" placeholder="term_id" />
                      <input id="class-grade" placeholder="grade_year" />
                      <button class="btn-ghost" type="button" id="create-class-btn">创建班级</button>
                    </div>
                    <div class="form-field">
                      <label>课程</label>
                      <input id="course-code" placeholder="课程编码" />
                      <input id="course-name" placeholder="课程名称" />
                      <input id="course-major" placeholder="major_id" />
                      <input id="course-term" placeholder="term_id" />
                      <input id="course-teacher" placeholder="teacher_id" />
                      <input id="course-class" placeholder="class_id (教学班)" />
                      <input id="course-type" placeholder="类型(必修/选修...)" />
                      <button class="btn-ghost" type="button" id="create-course-btn">创建课程</button>
                    </div>
                  </div>
                  <div id="create-class-status" class="muted"></div>
                  <div id="create-course-status" class="muted"></div>
                </div>
              </div>
              <div class="grid-2" style="margin-top: 12px;">
                <div class="panel" style="box-shadow:none; border-style:dashed;">
                  <div class="section-note">培养方案</div>
                  <div class="form-field">
                    <input id="plan-name" placeholder="方案名称" />
                    <input id="plan-entry" placeholder="entry_year" />
                    <input id="plan-major" placeholder="major_id" />
                    <input id="plan-courses" placeholder="课程ID列表, 逗号分隔" />
                    <button class="btn-ghost" type="button" id="create-plan-btn">创建方案</button>
                  </div>
                  <div id="create-plan-status" class="muted"></div>
                </div>
                <div class="panel" style="box-shadow:none; border-style:dashed;">
                  <div class="section-note">排课（冲突检测）</div>
                  <div class="form-grid">
                    <div class="form-field">
                      <label>基础信息</label>
                      <input id="sched-course" placeholder="course_id" />
                      <input id="sched-class" placeholder="class_id" />
                      <input id="sched-teacher" placeholder="teacher_id" />
                    </div>
                    <div class="form-field">
                      <label>时间地点</label>
                      <input id="sched-weekday" placeholder="weekday (1-7)" />
                      <input id="sched-start" placeholder="start_slot" />
                      <input id="sched-end" placeholder="end_slot" />
                      <input id="sched-location" placeholder="location" />
                    </div>
                  </div>
                  <button class="btn-primary" type="button" id="create-schedule-btn" style="margin-top:8px;">提交排课</button>
                  <div id="create-schedule-status" class="muted"></div>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script>
      const apiBase = "http://localhost:8000";
      let token = null;
      let currentRoles = [];

      const loginForm = document.getElementById("login-form");
      const loginStatus = document.getElementById("login-status");
      const loginScreen = document.getElementById("login-screen");
      const appShell = document.getElementById("app-shell");

      function setStatus(msg, isError = false) {
        loginStatus.textContent = msg;
        loginStatus.style.color = isError ? "#c36a00" : "var(--muted)";
      }

      async function authFetch(path, options = {}) {
        if (!token) throw new Error("请先登录");
        const headers = options.headers || {};
        headers["Authorization"] = "Bearer " + token;
        if (!headers["Content-Type"] && options.body) {
          headers["Content-Type"] = "application/json";
        }
        const resp = await fetch(apiBase + path, { ...options, headers });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || "请求失败");
        }
        return resp.json();
      }

      function renderCounters(counters = {}) {
        const container = document.getElementById("kpi-grid");
        const keys = [
          { key: "students", label: "学员" },
          { key: "teachers", label: "教师" },
          { key: "classes", label: "班级" },
          { key: "courses", label: "教学班" },
        ];
        container.innerHTML = keys
          .map(
            (item) => `<div class="kpi">
              <div class="label">${item.label}</div>
              <div class="value">${counters[item.key] ?? "-"}</div>
            </div>`
          )
          .join("");
      }

      function renderSchedule(list, mountId) {
        const el = document.getElementById(mountId);
        if (!list || list.length === 0) {
          el.textContent = "暂无数据";
          return;
        }
        const weekdays = ["一", "二", "三", "四", "五", "六", "日"];
        el.innerHTML = `<table>
          <thead><tr><th>星期</th><th>节次</th><th>课程</th><th>地点</th><th>班级</th></tr></thead>
          <tbody>
            ${list
              .map((row) => {
                const course = row.course?.name || row.course_id;
                const cls = row.class_info?.name || row.class_id;
                return `<tr>
                  <td>周${weekdays[row.weekday - 1] || row.weekday}</td>
                  <td>${row.start_slot}-${row.end_slot}</td>
                  <td>${course}</td>
                  <td>${row.location || "-"}</td>
                  <td>${cls || "-"}</td>
                </tr>`;
              })
              .join("")}
          </tbody>
        </table>`;
      }

      function renderGrades(list, mountId) {
        const el = document.getElementById(mountId);
        if (!list || list.length === 0) {
          el.textContent = "暂无成绩";
          return;
        }
        el.innerHTML = `<table>
          <thead><tr><th>课程</th><th>平时</th><th>期末</th><th>总评</th><th>状态</th></tr></thead>
          <tbody>
            ${list
              .map(
                (g) => `<tr>
                <td>${g.course?.name || g.course_id}</td>
                <td>${g.usual_score ?? "-"}</td>
                <td>${g.final_score ?? "-"}</td>
                <td>${g.total_score ?? "-"}</td>
                <td><span class="tag ${g.status === "published" ? "tag-green" : "tag-amber"}">${g.status}</span></td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
      }

      function renderMenus(menus) {
        const quick = document.getElementById("menu-quick");
        const sidebar = document.getElementById("sidebar-menu");
        quick.innerHTML = menus
          .map(
            (m) => `<div class="quick-card" data-target="${m.path}">
                <div style="font-weight:700">${m.label}</div>
                <div class="muted" style="font-size:12px;">${m.path}</div>
              </div>`
          )
          .join("");
        sidebar.innerHTML = menus
          .map(
            (m) => `<li class="nav-item" data-target="${m.path}">
              ${m.label}
              <div class="hint">${m.path}</div>
            </li>`
          )
          .join("");
        document.querySelectorAll("[data-target]").forEach((node) => {
          node.addEventListener("click", () => {
            const target = node.getAttribute("data-target");
            if (target.includes("student")) {
              document.getElementById("student-block").scrollIntoView({ behavior: "smooth" });
            } else if (target.includes("teacher")) {
              document.getElementById("teacher-block").scrollIntoView({ behavior: "smooth" });
            } else if (target.includes("admin")) {
              document.getElementById("admin-block").scrollIntoView({ behavior: "smooth" });
            }
          });
        });
      }

      function renderStudents(list) {
        const el = document.getElementById("admin-students");
        if (!list || list.length === 0) {
          el.textContent = "暂无学籍数据";
          return;
        }
        el.innerHTML = `<table>
          <thead><tr><th>学号</th><th>姓名</th><th>班级</th><th>状态</th></tr></thead>
          <tbody>
            ${list
              .map(
                (s) => `<tr>
                <td>${s.student_no}</td>
                <td>${s.user?.full_name || "-"}</td>
                <td>${s.class_info?.name || "-"}</td>
                <td>${s.status}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
      }

      function renderPlans(list) {
        const el = document.getElementById("admin-plans");
        if (!list || list.length === 0) {
          el.textContent = "暂无培养方案";
          return;
        }
        el.innerHTML = list
          .map((plan) => {
            const items = plan.items
              .map(
                (i) =>
                  `<div class="muted">第${i.term_no}学期 · ${i.course?.name || i.course_id} · ${i.weekly_hours}学时 · ${i.exam_type}</div>`
              )
              .join("");
            return `<div style="margin-bottom:12px">
              <div style="font-weight:700">${plan.name}（${plan.entry_year}级）</div>
              ${items}
            </div>`;
          })
          .join("");
      }

      function updateVisibleBlocks() {
        document.getElementById("student-block").classList.toggle(
          "hidden",
          !currentRoles.includes("STUDENT")
        );
        document.getElementById("teacher-block").classList.toggle(
          "hidden",
          !currentRoles.includes("TEACHER")
        );
        document.getElementById("admin-block").classList.toggle(
          "hidden",
          !currentRoles.includes("ADMIN")
        );
      }

      async function loadDashboard() {
        const home = await authFetch("/api/home");
        renderCounters(home.counters);
        renderSchedule(home.schedule_preview, "schedule-preview");
        if (home.latest_grades) {
          renderGrades(home.latest_grades, "student-grades");
        }
      }

      async function loadStudentData() {
        if (!currentRoles.includes("STUDENT")) return;
        const [schedule, grades] = await Promise.all([
          authFetch("/api/schedule/my"),
          authFetch("/api/grades/my"),
        ]);
        renderSchedule(schedule, "student-schedule");
        renderGrades(grades, "student-grades");
      }

      async function loadTeacherData() {
        if (!currentRoles.includes("TEACHER")) return;
        const schedule = await authFetch("/api/schedule/my");
        renderSchedule(schedule, "teacher-schedule");
        const courses = await authFetch("/api/courses?mine=true");
        const rows = courses
          .map(
            (c) =>
              `<tr><td>${c.name}</td><td>${c.class_id || "-"}</td><td>${c.term_id}</td><td>${c.weekly_hours}学时</td></tr>`
          )
          .join("");
        document.getElementById("teacher-grades").innerHTML = `<table>
          <thead><tr><th>课程</th><th>班级ID</th><th>学期ID</th><th>学时</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
      }

      async function loadAdminData() {
        if (!currentRoles.includes("ADMIN")) return;
        const [students, plans] = await Promise.all([
          authFetch("/api/students"),
          authFetch("/api/training-plans"),
        ]);
        renderStudents(students);
        renderPlans(plans);
      }

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password) {
          setStatus("请输入用户名和密码", true);
          return;
        }
        setStatus("登录中...");
        try {
          const resp = await fetch(apiBase + "/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || "登录失败");
          }
          const data = await resp.json();
          token = data.access_token;
          currentRoles = data.roles || [];
          loginScreen.classList.add("hidden");
          appShell.classList.remove("hidden");
          document.getElementById("welcome-title").textContent = `欢迎，${data.user.full_name}`;
          document.getElementById("welcome-roles").textContent = `角色：${currentRoles.join(" / ")}`;
          document.getElementById("welcome-roles-top").textContent = currentRoles.join(" / ");
          const menuResp = await authFetch("/api/menus");
          renderMenus(menuResp.menus);
          updateVisibleBlocks();
          loadDashboard();
          loadStudentData();
          loadTeacherData();
          loadAdminData();
          setStatus("");
        } catch (err) {
          setStatus(err.message, true);
        }
      });

      document.getElementById("fill-student").addEventListener("click", () => {
        document.getElementById("username").value = "student1";
        document.getElementById("password").value = "student123";
      });
      document.getElementById("fill-teacher").addEventListener("click", () => {
        document.getElementById("username").value = "teacher1";
        document.getElementById("password").value = "teacher123";
      });
      document.getElementById("fill-admin").addEventListener("click", () => {
        document.getElementById("username").value = "admin";
        document.getElementById("password").value = "admin123";
      });

      document.getElementById("logout-btn").addEventListener("click", () => {
        token = null;
        currentRoles = [];
        appShell.classList.add("hidden");
        loginScreen.classList.remove("hidden");
      });

      async function handleCreateClass() {
        const payload = {
          code: document.getElementById("class-code").value.trim(),
          name: document.getElementById("class-name").value.trim(),
          major_id: Number(document.getElementById("class-major").value),
          term_id: Number(document.getElementById("class-term").value),
          grade_year: document.getElementById("class-grade").value
            ? Number(document.getElementById("class-grade").value)
            : undefined,
        };
        const statusEl = document.getElementById("create-class-status");
        try {
          const res = await authFetch("/api/classes", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `班级创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleCreateCourse() {
        const payload = {
          code: document.getElementById("course-code").value.trim(),
          name: document.getElementById("course-name").value.trim(),
          major_id: Number(document.getElementById("course-major").value),
          term_id: Number(document.getElementById("course-term").value),
          teacher_id: document.getElementById("course-teacher").value
            ? Number(document.getElementById("course-teacher").value)
            : undefined,
          class_id: document.getElementById("course-class").value
            ? Number(document.getElementById("course-class").value)
            : undefined,
          course_type: document.getElementById("course-type").value || undefined,
        };
        const statusEl = document.getElementById("create-course-status");
        try {
          const res = await authFetch("/api/courses", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `课程创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleCreatePlan() {
        const statusEl = document.getElementById("create-plan-status");
        const courses = document
          .getElementById("plan-courses")
          .value.split(",")
          .map((v) => Number(v.trim()))
          .filter(Boolean);
        const payload = {
          name: document.getElementById("plan-name").value.trim(),
          entry_year: Number(document.getElementById("plan-entry").value),
          major_id: Number(document.getElementById("plan-major").value),
          item_course_ids: courses,
        };
        try {
          const res = await authFetch("/api/training-plans", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `方案创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleScheduleCreate() {
        const statusEl = document.getElementById("create-schedule-status");
        const payload = {
          course_id: Number(document.getElementById("sched-course").value),
          class_id: document.getElementById("sched-class").value
            ? Number(document.getElementById("sched-class").value)
            : undefined,
          teacher_id: document.getElementById("sched-teacher").value
            ? Number(document.getElementById("sched-teacher").value)
            : undefined,
          weekday: Number(document.getElementById("sched-weekday").value),
          start_slot: Number(document.getElementById("sched-start").value),
          end_slot: Number(document.getElementById("sched-end").value),
          location: document.getElementById("sched-location").value || undefined,
        };
        try {
          const res = await authFetch("/api/schedule", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `排课成功：ID ${res.id}`;
          statusEl.style.color = "var(--muted)";
          loadStudentData();
          loadTeacherData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleImportStudents() {
        const statusEl = document.getElementById("import-students-status");
        let data;
        try {
          data = JSON.parse(document.getElementById("import-students-input").value || "[]");
        } catch (e) {
          statusEl.textContent = "JSON 格式错误";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/students/import", {
            method: "POST",
            body: JSON.stringify({ students: data }),
          });
          statusEl.textContent = `导入完成：成功 ${res.created}，跳过 ${res.skipped}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      // 绑定按钮事件
      document.getElementById("create-class-btn").addEventListener("click", handleCreateClass);
      document.getElementById("create-course-btn").addEventListener("click", handleCreateCourse);
      document.getElementById("create-plan-btn").addEventListener("click", handleCreatePlan);
      document.getElementById("create-schedule-btn").addEventListener("click", handleScheduleCreate);
      document.getElementById("import-students-btn").addEventListener("click", handleImportStudents);
    </script>
  </body>
</html>
