<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>警院教务中心 · P0/P1 MVP</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --panel: #ffffff;
        --border: #e6e8ec;
        --text: #1e2a3b;
        --muted: #6e7c91;
        --accent: #0f5ae0;
        --accent-2: #17b39b;
        --shadow: 0 14px 40px rgba(15, 90, 224, 0.08);
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Source Sans Pro", "Noto Sans SC", "Microsoft YaHei", sans-serif;
      }

      a {
        color: var(--accent);
      }

      .hidden {
        display: none !important;
      }

      /* 登录遮罩 */
      #login-screen {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 10% 20%, rgba(15, 90, 224, 0.08), transparent 20%),
          radial-gradient(circle at 80% 10%, rgba(23, 179, 155, 0.12), transparent 25%),
          var(--bg);
        padding: 24px;
      }

      .login-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 32px;
        max-width: 820px;
        width: 100%;
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 28px;
      }

      .login-card h1 {
        margin: 0 0 8px;
        font-size: 24px;
        font-weight: 800;
      }

      .pill {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(15, 90, 224, 0.08);
        color: var(--accent);
        font-size: 12px;
        font-weight: 700;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      form {
        display: grid;
        gap: 12px;
      }

      input,
      button {
        font: inherit;
      }

      input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fafbfe;
      }

      input:focus {
        outline: 2px solid rgba(15, 90, 224, 0.18);
        border-color: rgba(15, 90, 224, 0.3);
      }

      button {
        border: none;
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.15s ease;
      }

      .btn-primary {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 10px 20px rgba(15, 90, 224, 0.18);
      }

      .btn-ghost {
        background: #f2f4f8;
        color: var(--text);
        border: 1px solid var(--border);
      }

      button:hover {
        transform: translateY(-1px);
      }

      /* 应用布局 */
      #app-shell {
        min-height: 100vh;
      }

      .topbar {
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        background: #0c2340;
        color: #f3f6fb;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: 0.5px;
      }

      .brand-badge {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, #0f5ae0, #17b39b);
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 900;
      }

      .user-chip {
        padding: 8px 12px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.12);
        font-size: 13px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .shell-body {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: calc(100vh - 64px);
      }

      .sidebar {
        background: #ffffff;
        border-right: 1px solid var(--border);
        padding: 18px 16px;
      }

      .nav-title {
        font-weight: 700;
        margin-bottom: 12px;
        color: #0f5ae0;
      }

      .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
      }

      .nav-item {
        padding: 10px 12px;
        border-radius: 10px;
        color: var(--text);
        border: 1px solid var(--border);
        background: #fbfcff;
        font-size: 14px;
      }

      .nav-item .hint {
        color: var(--muted);
        font-size: 12px;
      }

      .content {
        padding: 24px;
        display: grid;
        gap: 16px;
      }

      .hero {
        background: linear-gradient(120deg, rgba(15, 90, 224, 0.12), rgba(23, 179, 155, 0.08));
        border: 1px solid rgba(15, 90, 224, 0.08);
        border-radius: var(--radius);
        padding: 18px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .hero h2 {
        margin: 0 0 6px;
        font-size: 20px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px 18px;
      }

      .panel-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        font-weight: 800;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .kpi {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fbfcff;
      }

      .kpi .label {
        color: var(--muted);
        font-size: 13px;
      }

      .kpi .value {
        font-size: 28px;
        font-weight: 800;
        margin-top: 6px;
        color: var(--accent);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid var(--border);
      }

      th {
        color: var(--muted);
        font-weight: 700;
      }

      .tag {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
      }

      .tag-green {
        background: rgba(23, 179, 155, 0.12);
        color: #0f8b7b;
      }

      .tag-amber {
        background: rgba(255, 184, 53, 0.16);
        color: #c36a00;
      }

      .quick-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .quick-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fbfcff;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .quick-card:hover {
        border-color: var(--accent);
        box-shadow: 0 12px 24px rgba(15, 90, 224, 0.12);
      }

      .section-note {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 8px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }

      .form-field {
        display: grid;
        gap: 6px;
      }

      .form-field label {
        font-size: 13px;
        color: var(--muted);
      }

      textarea {
        width: 100%;
        min-height: 90px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fafbfe;
        font: inherit;
      }

      @media (max-width: 980px) {
        .shell-body {
          grid-template-columns: 1fr;
        }
        .sidebar {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <div class="login-card">
        <div>
          <div class="pill">警院教务中心 · P0/P1</div>
          <h1>统一登录</h1>
          <div class="muted">使用不同账号体验学生 / 教师 / 教务角色。</div>
          <form id="login-form" style="margin-top: 14px">
            <input id="username" placeholder="用户名：admin / teacher1 / student1" />
            <input id="password" placeholder="密码" type="password" />
            <div style="display: flex; gap: 12px; align-items: center; justify-content: center;">
              <button class="btn-primary" type="submit" style="min-width: 140px; padding: 14px 18px; font-size: 15px;">登录</button>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px; justify-content: center; flex-wrap: wrap;">
              <button class="btn-ghost" type="button" id="fill-student" style="min-width: 110px; padding: 10px 12px;">student1</button>
              <button class="btn-ghost" type="button" id="fill-teacher" style="min-width: 110px; padding: 10px 12px;">teacher1</button>
              <button class="btn-ghost" type="button" id="fill-admin" style="white-space: nowrap; min-width: 110px; padding: 10px 12px;">admin</button>
            </div>
            <div id="login-status" class="muted"></div>
          </form>
        </div>
        <div>
          <div class="pill" style="background: rgba(23,179,155,0.12); color:#0f8b7b;">当前能力</div>
          <ul class="muted" style="line-height: 1.6; margin-top: 10px;">
            <li>账号/角色/菜单（P0）</li>
            <li>学籍、课程、培养方案（P1）</li>
            <li>排课与课表、成绩录入/发布（P1）</li>
          </ul>
          <div class="muted" style="margin-top: 16px;">演示账号密码均为“账号+123”。</div>
        </div>
      </div>
    </div>

    <div id="app-shell" class="hidden">
      <header class="topbar">
        <div class="brand">
          <div class="brand-badge">PA</div>
          <div>
            <div style="font-size: 16px; font-weight: 800;">警院教务中心</div>
            <div style="font-size: 12px; color: #c9d6ea;">Academic & Training Portal</div>
          </div>
        </div>
        <div class="user-chip" id="user-chip">
          <span id="welcome-roles-top"></span>
          <button id="logout-btn" class="btn-ghost" style="padding:6px 10px;">退出</button>
        </div>
      </header>
      <div class="shell-body">
        <aside class="sidebar">
          <div class="nav-title">常用导航</div>
          <ul class="nav-list" id="sidebar-menu">
            <li class="nav-item">
              首页看板
              <div class="hint">核心数据 / 待办</div>
            </li>
            <li class="nav-item">
              学籍与班级
              <div class="hint">导入/查询学籍</div>
            </li>
            <li class="nav-item">
              课程与教学班
              <div class="hint">排课 / 课表</div>
            </li>
            <li class="nav-item">
              成绩与发布
              <div class="hint">录入 / 审核 / 查看</div>
            </li>
          </ul>
        </aside>
        <main class="content">
          <section class="hero">
            <div>
              <h2 id="welcome-title">欢迎</h2>
              <div class="muted" id="welcome-roles"></div>
            </div>
            <div class="muted">演示数据已预置，可直接体验课表、成绩、方案。</div>
          </section>

          <section class="panel">
            <div class="panel-head">
              <span>核心数据概览</span>
            </div>
            <div id="kpi-grid" class="kpi-grid"></div>
          </section>

          <div class="grid-2">
            <section class="panel">
              <div class="panel-head">
                <span>近期课表</span>
              </div>
              <div id="schedule-preview" class="muted">暂无课表</div>
            </section>
            <section class="panel">
              <div class="panel-head">
                <span>角色快捷入口</span>
              </div>
              <div id="menu-quick" class="quick-cards"></div>
            </section>
          </div>

          <section id="student-block" class="panel hidden">
            <div class="panel-head">
              <span>学生视角</span>
              <span class="muted">我的课表、成绩、考试</span>
            </div>
            <div class="grid-2">
              <div>
                <div class="section-note">我的课表</div>
                <div id="student-schedule" class="muted">加载中...</div>
              </div>
              <div>
                <div class="section-note">我的成绩</div>
                <div id="student-grades" class="muted">加载中...</div>
              </div>
            </div>
            <div style="margin-top:12px;">
              <div class="section-note">我的考试</div>
              <div id="student-exams" class="muted">加载中...</div>
            </div>
          </section>

          <section id="teacher-block" class="panel hidden">
            <div class="panel-head">
              <span>教师视角</span>
              <span class="muted">授课安排、课程、考试</span>
            </div>
            <div class="grid-2">
              <div>
                <div class="section-note">授课安排</div>
                <div id="teacher-schedule" class="muted">加载中...</div>
              </div>
              <div>
                <div class="section-note">课程列表（演示）</div>
                <div id="teacher-grades" class="muted">加载中...</div>
              </div>
            </div>
            <div style="margin-top:12px;">
              <div class="section-note">考试安排</div>
              <div id="teacher-exams" class="muted">加载中...</div>
            </div>
          </section>

          <section id="admin-block" class="panel hidden">
            <div class="panel-head">
              <span>教务视角</span>
              <span class="muted">学籍与培养方案</span>
            </div>
            <div class="grid-2">
              <div>
                <div class="section-note">学籍快览</div>
                <div id="admin-students" class="muted">加载中...</div>
                <div class="form-grid" style="margin-top:8px;">
                  <input id="student-search" placeholder="学号/姓名模糊" />
                  <input id="student-class-filter" placeholder="class_id" />
                  <button class="btn-ghost" type="button" id="filter-students-btn">筛选学籍</button>
                </div>
              </div>
              <div>
                <div class="section-note">培养方案</div>
                <div id="admin-plans" class="muted">加载中...</div>
              </div>
            </div>

            <div class="grid-2" style="margin-top: 12px;">
              <div class="panel" style="box-shadow:none; border-style:dashed;">
                <div class="panel-head"><span>学期列表</span></div>
                <div id="admin-terms" class="muted">加载中...</div>
              </div>
              <div class="panel" style="box-shadow:none; border-style:dashed;">
                <div class="panel-head"><span>学期管理</span></div>
                <div class="form-grid">
                  <input id="term-name" placeholder="名称 (唯一)" />
                  <input id="term-start" placeholder="开始日期 YYYY-MM-DD" />
                  <input id="term-end" placeholder="结束日期 YYYY-MM-DD" />
                  <label class="muted" style="display:flex;gap:8px;align-items:center;">
                    <input type="checkbox" id="term-current" /> 设为当前学期
                  </label>
                  <button class="btn-primary" type="button" id="create-term-btn">创建学期</button>
                  <div id="create-term-status" class="muted"></div>
                </div>
                <div class="form-grid" style="margin-top:8px;">
                  <input id="term-edit-id" placeholder="term_id" />
                  <input id="term-edit-name" placeholder="新名称(可空)" />
                  <input id="term-edit-start" placeholder="开始日期(可空)" />
                  <input id="term-edit-end" placeholder="结束日期(可空)" />
                  <label class="muted" style="display:flex;gap:8px;align-items:center;">
                    <input type="checkbox" id="term-edit-current" /> 设为当前（不勾选不改）
                  </label>
                  <button class="btn-ghost" type="button" id="update-term-btn">更新学期</button>
                  <div id="update-term-status" class="muted"></div>
                </div>
              </div>
            </div>

            <div class="panel" style="margin-top: 16px; box-shadow:none; border-style:dashed;">
              <div class="panel-head"><span>学籍导入</span><span class="muted">JSON 列表</span></div>
              <textarea id="import-students-input" placeholder='[{"username":"s100","password":"pass","full_name":"学生","student_no":"2024100","class_id":1}]'></textarea>
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
                <button class="btn-primary" id="import-students-btn">导入学籍</button>
                <span id="import-students-status" class="muted"></span>
              </div>
            </div>

            <div class="grid-2" style="margin-top: 12px;">
              <div class="panel" style="box-shadow:none; border-style:dashed;">
                <div class="panel-head"><span>班级管理</span></div>
                <div class="section-note">班级列表</div>
                <div id="admin-classes" class="muted">加载中...</div>
                <div class="section-note" style="margin-top:8px;">新建班级</div>
                <div class="form-grid">
                  <input id="class-code" placeholder="班级编码" />
                  <input id="class-name" placeholder="班级名称" />
                  <input id="class-major" placeholder="major_id" />
                  <input id="class-term" placeholder="term_id" />
                  <input id="class-grade" placeholder="grade_year" />
                  <button class="btn-ghost" type="button" id="create-class-btn">创建班级</button>
                </div>
                <div id="create-class-status" class="muted"></div>
              </div>
              <div class="panel" style="box-shadow:none; border-style:dashed;">
                <div class="panel-head"><span>课程管理</span></div>
                <div class="section-note">课程列表</div>
                <div id="admin-courses" class="muted">加载中...</div>
                <div class="section-note" style="margin-top:8px;">新建课程</div>
                <div class="form-grid">
                  <input id="course-code" placeholder="课程编码" />
                  <input id="course-name" placeholder="课程名称" />
                  <input id="course-major" placeholder="major_id" />
                  <input id="course-term" placeholder="term_id" />
                  <input id="course-teacher" placeholder="teacher_id" />
                  <input id="course-class" placeholder="class_id (教学班)" />
                  <input id="course-type" placeholder="类型(必修/选修...)" />
                  <button class="btn-ghost" type="button" id="create-course-btn">创建课程</button>
                </div>
                <div id="create-course-status" class="muted"></div>
              </div>
            </div>

            <div class="grid-2" style="margin-top: 12px;">
              <div class="panel" style="box-shadow:none; border-style:dashed;">
                <div class="panel-head"><span>培养方案</span></div>
                <div class="form-field">
                  <input id="plan-name" placeholder="方案名称" />
                  <input id="plan-entry" placeholder="entry_year" />
                  <input id="plan-major" placeholder="major_id" />
                  <input id="plan-courses" placeholder="课程ID列表, 逗号分隔" />
                  <button class="btn-ghost" type="button" id="create-plan-btn">创建方案</button>
                </div>
                <div id="create-plan-status" class="muted"></div>
              </div>
              <div class="panel" style="box-shadow:none; border-style:dashed;">
                <div class="panel-head"><span>排课（冲突检测）</span></div>
                <div class="form-grid">
                  <div class="form-field">
                    <label>基础信息</label>
                    <input id="sched-course" placeholder="course_id" />
                    <input id="sched-class" placeholder="class_id" />
                    <input id="sched-teacher" placeholder="teacher_id" />
                  </div>
                  <div class="form-field">
                    <label>时间地点</label>
                    <input id="sched-weekday" placeholder="weekday (1-7)" />
                    <input id="sched-start" placeholder="start_slot" />
                    <input id="sched-end" placeholder="end_slot" />
                    <input id="sched-location" placeholder="location" />
                  </div>
                </div>
                <button class="btn-primary" type="button" id="create-schedule-btn" style="margin-top:8px;">提交排课</button>
                <div id="create-schedule-status" class="muted"></div>
                <div class="section-note" style="margin-top:8px;">课表查询</div>
                <div class="form-grid">
                  <input id="schedule-class-filter" placeholder="class_id" />
                  <input id="schedule-teacher-filter" placeholder="teacher_id" />
                  <button class="btn-ghost" type="button" id="load-schedule-btn">刷新课表</button>
                </div>
                <div id="admin-schedule" class="muted" style="margin-top:8px;">待查询</div>
              </div>
            </div>

            <div class="panel" style="margin-top: 12px; box-shadow:none; border-style:dashed;">
              <div class="panel-head">
                <span>成绩审核</span>
                <span class="muted">按课程/班级筛选，审核与发布</span>
              </div>
              <div class="form-grid">
                <input id="grade-course-filter" placeholder="course_id" />
                <input id="grade-class-filter" placeholder="class_id" />
                <input id="grade-status-filter" placeholder="状态(draft/submitted/published)" />
                <button class="btn-ghost" type="button" id="load-grades-btn">拉取成绩</button>
              </div>
              <div id="admin-grades" class="muted" style="margin-top:8px;">待查询</div>
              <div class="form-grid" style="margin-top:8px;">
                <input id="grade-review-id" placeholder="grade_id" />
                <input id="grade-review-comment" placeholder="审核备注(可空)" />
                <div style="display:flex;gap:8px;">
                  <button class="btn-primary" type="button" id="approve-grade-btn">审核通过</button>
                  <button class="btn-ghost" type="button" id="reject-grade-btn">驳回</button>
                </div>
                <div id="grade-review-status" class="muted"></div>
              </div>
              <div class="form-grid" style="margin-top:8px;">
                <input id="grade-publish-course" placeholder="course_id" />
                <input id="grade-publish-reviewer" placeholder="审核人(可空)" />
                <button class="btn-ghost" type="button" id="publish-grades-btn">批量发布课程成绩</button>
                <div id="grade-publish-status" class="muted"></div>
              </div>
              <div class="grid-2" style="margin-top:8px;">
                <div class="panel" style="box-shadow:none; border-style:dashed;">
                  <div class="section-note">成绩导入（JSON 列表）</div>
                  <textarea id="import-grades-input" placeholder='[{"student_id":1,"course_id":1,"term_id":1,"usual_score":80,"final_score":85}]'></textarea>
                  <button class="btn-primary" type="button" id="import-grades-btn" style="margin-top:6px;">导入成绩</button>
                  <div id="import-grades-status" class="muted"></div>
                </div>
                <div class="panel" style="box-shadow:none; border-style:dashed;">
                  <div class="section-note">成绩导出</div>
                  <div class="form-grid">
                    <input id="export-grade-course" placeholder="course_id 可空" />
                    <input id="export-grade-class" placeholder="class_id 可空" />
                    <button class="btn-ghost" type="button" id="export-grades-btn">导出成绩 (JSON)</button>
                  </div>
                  <div id="export-grades-status" class="muted"></div>
                </div>
              </div>
            </div>

            <div class="panel" style="margin-top: 12px; box-shadow:none; border-style:dashed;">
              <div class="panel-head">
                <span>考试安排</span>
                <span class="muted">创建 / 查询</span>
              </div>
              <div class="grid-2">
                <div>
                  <div class="section-note">考试列表</div>
                  <div id="admin-exams" class="muted">加载中...</div>
                </div>
                <div class="form-grid">
                  <input id="exam-course" placeholder="course_id" />
                  <input id="exam-class" placeholder="class_id 可空" />
                  <input id="exam-term" placeholder="term_id 可空" />
                  <input id="exam-type" placeholder="类型(期中/期末/补考…)" />
                  <input id="exam-date" placeholder="考试日期 YYYY-MM-DD" />
                  <input id="exam-start" placeholder="开始时间 HH:MM 可空" />
                  <input id="exam-duration" placeholder="时长(分钟)" />
                  <input id="exam-location" placeholder="地点" />
                  <input id="exam-invigilators" placeholder="监考教师(文本)" />
                  <button class="btn-primary" type="button" id="create-exam-btn">创建考试</button>
                  <div id="create-exam-status" class="muted"></div>
                </div>
              </div>
            </div>

            <div class="panel" style="margin-top: 16px; box-shadow:none; border-style:dashed;">
              <div class="panel-head">
                <span>专业管理</span>
                <span class="muted">增改 / 启停用 / 层级</span>
              </div>
              <div class="grid-2">
                <div>
                  <div class="section-note">专业列表</div>
                  <div id="admin-majors" class="muted">加载中...</div>
                </div>
                <div class="form-grid">
                  <div class="form-field">
                    <label>新增专业</label>
                    <input id="major-code" placeholder="编码 (唯一)" />
                    <input id="major-name" placeholder="名称" />
                    <input id="major-level" placeholder="层级(本科/专科/方向)" />
                    <input id="major-degree" placeholder="学位/门类" />
                    <input id="major-duration" placeholder="学制(年)" />
                    <input id="major-org" placeholder="org_unit_id 可空" />
                    <input id="major-parent" placeholder="parent_id 可空" />
                    <input id="major-desc" placeholder="简介" />
                    <label class="muted" style="display:flex;gap:8px;align-items:center;">
                      <input type="checkbox" id="major-active" checked /> 启用
                    </label>
                    <button class="btn-primary" type="button" id="create-major-btn">创建专业</button>
                    <div id="create-major-status" class="muted"></div>
                  </div>
                  <div class="form-field">
                    <label>编辑/启停用</label>
                    <input id="major-edit-id" placeholder="major_id" />
                    <input id="major-edit-name" placeholder="新名称(可空)" />
                    <input id="major-edit-level" placeholder="层级(可空)" />
                    <input id="major-edit-degree" placeholder="学位(可空)" />
                    <input id="major-edit-duration" placeholder="学制(年,可空)" />
                    <input id="major-edit-org" placeholder="org_unit_id 可空" />
                    <input id="major-edit-parent" placeholder="parent_id 可空" />
                    <input id="major-edit-desc" placeholder="简介(可空)" />
                    <label class="muted" style="display:flex;gap:8px;align-items:center;">
                      <input type="checkbox" id="major-edit-active" /> 启用（不勾选则停用，默认不改）
                    </label>
                    <button class="btn-ghost" type="button" id="update-major-btn">更新专业</button>
                    <div id="update-major-status" class="muted"></div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script>
      const apiBase = "http://localhost:8000";
      let token = null;
      let currentRoles = [];
      const PAGE_SIZE = 8;
      const adminStore = { students: [], classes: [], courses: [], majors: [], grades: [], terms: [] };
      const adminPage = { students: 1, classes: 1, courses: 1, majors: 1, grades: 1, terms: 1 };

      const loginForm = document.getElementById("login-form");
      const loginStatus = document.getElementById("login-status");
      const loginScreen = document.getElementById("login-screen");
      const appShell = document.getElementById("app-shell");

      function setStatus(msg, isError = false) {
        loginStatus.textContent = msg;
        loginStatus.style.color = isError ? "#c36a00" : "var(--muted)";
      }

      async function authFetch(path, options = {}) {
        if (!token) throw new Error("请先登录");
        const headers = options.headers || {};
        headers["Authorization"] = "Bearer " + token;
        if (!headers["Content-Type"] && options.body) {
          headers["Content-Type"] = "application/json";
        }
        const resp = await fetch(apiBase + path, { ...options, headers });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || "请求失败");
        }
        return resp.json();
      }

      function renderCounters(counters = {}) {
        const container = document.getElementById("kpi-grid");
        const keys = [
          { key: "students", label: "学员" },
          { key: "teachers", label: "教师" },
          { key: "classes", label: "班级" },
          { key: "courses", label: "教学班" },
        ];
        container.innerHTML = keys
          .map(
            (item) => `<div class="kpi">
              <div class="label">${item.label}</div>
              <div class="value">${counters[item.key] ?? "-"}</div>
            </div>`
          )
          .join("");
      }

      function renderPager(container, key, totalPages) {
        if (totalPages <= 1) return;
        const page = adminPage[key] || 1;
        const pager = document.createElement("div");
        pager.className = "muted";
        pager.style.marginTop = "6px";
        pager.innerHTML = `
          <button class="btn-ghost" data-pager="${key}" data-dir="prev" ${page <= 1 ? "disabled" : ""}>上一页</button>
          <span style="margin:0 8px;">${page} / ${totalPages}</span>
          <button class="btn-ghost" data-pager="${key}" data-dir="next" ${page >= totalPages ? "disabled" : ""}>下一页</button>
        `;
        pager.querySelectorAll("[data-pager]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const dir = btn.getAttribute("data-dir");
            adminPage[key] = dir === "next" ? page + 1 : page - 1;
            const map = {
              students: renderStudentsPage,
              classes: renderClassesPage,
              courses: renderCoursesPage,
              majors: renderMajorsPage,
              grades: renderAdminGradesPage,
            };
            map[key]?.();
          });
        });
        container.appendChild(pager);
      }

      function renderSchedule(list, mountId) {
        const el = document.getElementById(mountId);
        if (!list || list.length === 0) {
          el.textContent = "暂无数据";
          return;
        }
        const weekdays = ["一", "二", "三", "四", "五", "六", "日"];
        el.innerHTML = `<table>
          <thead><tr><th>星期</th><th>节次</th><th>课程</th><th>地点</th><th>班级</th></tr></thead>
          <tbody>
            ${list
              .map((row) => {
                const course = row.course?.name || row.course_id;
                const cls = row.class_info?.name || row.class_id;
                return `<tr>
                  <td>周${weekdays[row.weekday - 1] || row.weekday}</td>
                  <td>${row.start_slot}-${row.end_slot}</td>
                  <td>${course}</td>
                  <td>${row.location || "-"}</td>
                  <td>${cls || "-"}</td>
                </tr>`;
              })
              .join("")}
          </tbody>
        </table>`;
      }

      function renderGrades(list, mountId) {
        const el = document.getElementById(mountId);
        if (!list || list.length === 0) {
          el.textContent = "暂无成绩";
          return;
        }
        el.innerHTML = `<table>
          <thead><tr><th>课程</th><th>平时</th><th>期末</th><th>总评</th><th>状态</th></tr></thead>
          <tbody>
            ${list
              .map(
                (g) => `<tr>
                <td>${g.course?.name || g.course_id}</td>
                <td>${g.usual_score ?? "-"}</td>
                <td>${g.final_score ?? "-"}</td>
                <td>${g.total_score ?? "-"}</td>
                <td><span class="tag ${g.status === "published" ? "tag-green" : "tag-amber"}">${g.status}</span></td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
      }

      function renderExams(list, mountId) {
        const el = document.getElementById(mountId);
        if (!list || list.length === 0) {
          el.textContent = "暂无考试";
          return;
        }
        el.innerHTML = `<table>
          <thead><tr><th>课程</th><th>班级</th><th>类型</th><th>日期</th><th>时间</th><th>时长</th><th>地点</th></tr></thead>
          <tbody>
            ${list
              .map(
                (x) => `<tr>
                <td>${x.course?.name || x.course_id}</td>
                <td>${x.class_info?.name || x.class_id || "-"}</td>
                <td>${x.exam_type || "-"}</td>
                <td>${x.exam_date || "-"}</td>
                <td>${x.start_time || "-"}</td>
                <td>${x.duration_minutes ?? "-"}</td>
                <td>${x.location || "-"}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
      }

      function renderMenus(menus) {
        const quick = document.getElementById("menu-quick");
        const sidebar = document.getElementById("sidebar-menu");
        quick.innerHTML = menus
          .map(
            (m) => `<div class="quick-card" data-target="${m.path}">
                <div style="font-weight:700">${m.label}</div>
                <div class="muted" style="font-size:12px;">${m.path}</div>
              </div>`
          )
          .join("");
        sidebar.innerHTML = menus
          .map(
            (m) => `<li class="nav-item" data-target="${m.path}">
              ${m.label}
              <div class="hint">${m.path}</div>
            </li>`
          )
          .join("");
        document.querySelectorAll("[data-target]").forEach((node) => {
          node.addEventListener("click", () => {
            const target = node.getAttribute("data-target");
            if (target.includes("student")) {
              document.getElementById("student-block").scrollIntoView({ behavior: "smooth" });
            } else if (target.includes("teacher")) {
              document.getElementById("teacher-block").scrollIntoView({ behavior: "smooth" });
            } else if (target.includes("admin")) {
              document.getElementById("admin-block").scrollIntoView({ behavior: "smooth" });
            }
          });
        });
      }

      function renderStudents(list) {
        adminStore.students = list || [];
        renderStudentsPage();
      }

      function renderStudentsPage() {
        const el = document.getElementById("admin-students");
        const list = adminStore.students || [];
        if (!list.length) {
          el.textContent = "暂无学籍数据";
          return;
        }
        const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
        const page = Math.min(Math.max(1, adminPage.students || 1), totalPages);
        adminPage.students = page;
        const pageList = list.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);
        el.innerHTML = `<table>
          <thead><tr><th>学号</th><th>姓名</th><th>班级</th><th>状态</th></tr></thead>
          <tbody>
            ${pageList
              .map(
                (s) => `<tr>
                <td>${s.student_no}</td>
                <td>${s.user?.full_name || "-"}</td>
                <td>${s.class_info?.name || "-"}</td>
                <td>${s.status}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
        renderPager(el, "students", totalPages);
      }

      function renderClasses(list) {
        adminStore.classes = list || [];
        renderClassesPage();
      }

      function renderClassesPage() {
        const el = document.getElementById("admin-classes");
        const list = adminStore.classes || [];
        if (!list.length) {
          el.textContent = "暂无班级";
          return;
        }
        const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
        const page = Math.min(Math.max(1, adminPage.classes || 1), totalPages);
        adminPage.classes = page;
        const pageList = list.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);
        el.innerHTML = `<table>
          <thead><tr><th>ID</th><th>编码</th><th>名称</th><th>专业</th><th>学期</th><th>年级</th></tr></thead>
          <tbody>
            ${pageList
              .map(
                (c) => `<tr>
                <td>${c.id}</td>
                <td>${c.code}</td>
                <td>${c.name}</td>
                <td>${c.major_id ?? "-"}</td>
                <td>${c.term_id ?? "-"}</td>
                <td>${c.grade_year ?? "-"}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
        renderPager(el, "classes", totalPages);
      }

      function renderCourses(list) {
        adminStore.courses = list || [];
        renderCoursesPage();
      }

      function renderCoursesPage() {
        const el = document.getElementById("admin-courses");
        const list = adminStore.courses || [];
        if (!list.length) {
          el.textContent = "暂无课程";
          return;
        }
        const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
        const page = Math.min(Math.max(1, adminPage.courses || 1), totalPages);
        adminPage.courses = page;
        const pageList = list.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);
        el.innerHTML = `<table>
          <thead><tr><th>ID</th><th>编码</th><th>名称</th><th>专业</th><th>学期</th><th>教师</th><th>班级</th><th>类型</th></tr></thead>
          <tbody>
            ${pageList
              .map(
                (c) => `<tr>
                <td>${c.id}</td>
                <td>${c.code}</td>
                <td>${c.name}</td>
                <td>${c.major_id ?? "-"}</td>
                <td>${c.term_id ?? "-"}</td>
                <td>${c.teacher_id ?? "-"}</td>
                <td>${c.class_id ?? "-"}</td>
                <td>${c.course_type ?? "-"}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
        renderPager(el, "courses", totalPages);
      }

      function renderAdminSchedule(list) {
        const el = document.getElementById("admin-schedule");
        if (!list || list.length === 0) {
          el.textContent = "暂无排课";
          return;
        }
        const weekdays = ["一", "二", "三", "四", "五", "六", "日"];
        el.innerHTML = `<table>
          <thead><tr><th>ID</th><th>周</th><th>节次</th><th>课程</th><th>班级</th><th>教师</th><th>地点</th></tr></thead>
          <tbody>
            ${list
              .map(
                (s) => `<tr>
                <td>${s.id}</td>
                <td>周${weekdays[s.weekday - 1] || s.weekday}</td>
                <td>${s.start_slot}-${s.end_slot}</td>
                <td>${s.course?.name || s.course_id}</td>
                <td>${s.class_info?.name || s.class_id || "-"}</td>
                <td>${s.teacher_id || "-"}</td>
                <td>${s.location || "-"}</td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
      }

      function renderAdminGrades(list) {
        adminStore.grades = list || [];
        renderAdminGradesPage();
      }

      function renderAdminGradesPage() {
        const el = document.getElementById("admin-grades");
        const list = adminStore.grades || [];
        if (!list.length) {
          el.textContent = "暂无成绩";
          return;
        }
        const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
        const page = Math.min(Math.max(1, adminPage.grades || 1), totalPages);
        adminPage.grades = page;
        const pageList = list.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);
        el.innerHTML = `<table>
          <thead><tr><th>ID</th><th>课程</th><th>学生</th><th>班级</th><th>平时</th><th>期末</th><th>总评</th><th>状态</th></tr></thead>
          <tbody>
            ${pageList
              .map(
                (g) => `<tr>
                <td>${g.id}</td>
                <td>${g.course?.name || g.course_id}</td>
                <td>${g.student?.user?.full_name || g.student_id}</td>
                <td>${g.student?.class_info?.name || g.student?.class_id || "-"}</td>
                <td>${g.usual_score ?? "-"}</td>
                <td>${g.final_score ?? "-"}</td>
                <td>${g.total_score ?? "-"}</td>
                <td><span class="tag ${g.status === "published" ? "tag-green" : "tag-amber"}">${g.status}</span></td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
        renderPager(el, "grades", totalPages);
      }

      function renderPlans(list) {
        const el = document.getElementById("admin-plans");
        if (!list || list.length === 0) {
          el.textContent = "暂无培养方案";
          return;
        }
        el.innerHTML = list
          .map((plan) => {
            const items = plan.items
              .map(
                (i) =>
                  `<div class="muted">第${i.term_no}学期 · ${i.course?.name || i.course_id} · ${i.weekly_hours}学时 · ${i.exam_type}</div>`
              )
              .join("");
            return `<div style="margin-bottom:12px">
              <div style="font-weight:700">${plan.name}（${plan.entry_year}级）</div>
              ${items}
            </div>`;
          })
          .join("");
      }

      function renderMajors(list) {
        adminStore.majors = list || [];
        renderMajorsPage();
      }

      function renderTerms(list) {
        adminStore.terms = list || [];
        renderTermsPage();
      }

      function renderMajorsPage() {
        const el = document.getElementById("admin-majors");
        const list = adminStore.majors || [];
        if (!list.length) {
          el.textContent = "暂无专业";
          return;
        }
        const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
        const page = Math.min(Math.max(1, adminPage.majors || 1), totalPages);
        adminPage.majors = page;
        const pageList = list.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);
        el.innerHTML = `<table>
          <thead><tr><th>ID</th><th>编码</th><th>名称</th><th>层级/学位</th><th>学制</th><th>上级</th><th>状态</th></tr></thead>
          <tbody>
            ${pageList
              .map(
                (m) => `<tr>
                <td>${m.id}</td>
                <td>${m.code}</td>
                <td>${m.name}</td>
                <td>${[m.level, m.degree].filter(Boolean).join(" / ") || "-"}</td>
                <td>${m.duration_years ?? "-"}</td>
                <td>${m.parent_id ?? "-"}</td>
                <td><span class="tag ${m.active ? "tag-green" : "tag-amber"}">${m.active ? "启用" : "停用"}</span></td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
        renderPager(el, "majors", totalPages);
      }

      function renderTermsPage() {
        const el = document.getElementById("admin-terms");
        const list = adminStore.terms || [];
        if (!list.length) {
          el.textContent = "暂无学期";
          return;
        }
        const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
        const page = Math.min(Math.max(1, adminPage.terms || 1), totalPages);
        adminPage.terms = page;
        const pageList = list.slice((page - 1) * PAGE_SIZE, page * PAGE_SIZE);
        el.innerHTML = `<table>
          <thead><tr><th>ID</th><th>名称</th><th>开始</th><th>结束</th><th>当前</th></tr></thead>
          <tbody>
            ${pageList
              .map(
                (t) => `<tr>
                <td>${t.id}</td>
                <td>${t.name}</td>
                <td>${t.start_date || "-"}</td>
                <td>${t.end_date || "-"}</td>
                <td><span class="tag ${t.is_current ? "tag-green" : "tag-amber"}">${t.is_current ? "是" : "否"}</span></td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
        renderPager(el, "terms", totalPages);
      }

      function updateVisibleBlocks() {
        document.getElementById("student-block").classList.toggle(
          "hidden",
          !currentRoles.includes("STUDENT")
        );
        document.getElementById("teacher-block").classList.toggle(
          "hidden",
          !currentRoles.includes("TEACHER")
        );
        document.getElementById("admin-block").classList.toggle(
          "hidden",
          !currentRoles.includes("ADMIN")
        );
      }

      async function loadDashboard() {
        const home = await authFetch("/api/home");
        renderCounters(home.counters);
        renderSchedule(home.schedule_preview, "schedule-preview");
        if (home.latest_grades) {
          renderGrades(home.latest_grades, "student-grades");
        }
      }

      async function loadStudentData() {
        if (!currentRoles.includes("STUDENT")) return;
        const [schedule, grades, exams] = await Promise.all([
          authFetch("/api/schedule/my"),
          authFetch("/api/grades/my"),
          authFetch("/api/exams/my"),
        ]);
        renderSchedule(schedule, "student-schedule");
        renderGrades(grades, "student-grades");
        renderExams(exams, "student-exams");
      }

      async function loadTeacherData() {
        if (!currentRoles.includes("TEACHER")) return;
        const [schedule, exams, courses] = await Promise.all([
          authFetch("/api/schedule/my"),
          authFetch("/api/exams/my"),
          authFetch("/api/courses?mine=true"),
        ]);
        renderSchedule(schedule, "teacher-schedule");
        const rows = courses
          .map(
            (c) =>
              `<tr><td>${c.name}</td><td>${c.class_id || "-"}</td><td>${c.term_id}</td><td>${c.weekly_hours}学时</td></tr>`
          )
          .join("");
        document.getElementById("teacher-grades").innerHTML = `<table>
          <thead><tr><th>课程</th><th>班级ID</th><th>学期ID</th><th>学时</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
        renderExams(exams, "teacher-exams");
      }

      async function loadScheduleAdmin() {
        if (!currentRoles.includes("ADMIN")) return;
        const classId = document.getElementById("schedule-class-filter").value;
        const teacherId = document.getElementById("schedule-teacher-filter").value;
        const qs = [];
        if (classId) qs.push(`class_id=${classId}`);
        if (teacherId) qs.push(`teacher_id=${teacherId}`);
        const list = await authFetch(`/api/schedule${qs.length ? "?" + qs.join("&") : ""}`);
        renderAdminSchedule(list);
      }

      async function loadGradesAdmin() {
        if (!currentRoles.includes("ADMIN")) return;
        const courseId = document.getElementById("grade-course-filter").value;
        const classId = document.getElementById("grade-class-filter").value;
        const status = document.getElementById("grade-status-filter").value;
        const qs = [];
        if (courseId) qs.push(`course_id=${courseId}`);
        if (classId) qs.push(`class_id=${classId}`);
        if (status) qs.push(`status_filter=${status}`);
        const list = await authFetch(`/api/grades${qs.length ? "?" + qs.join("&") : ""}`);
        renderAdminGrades(list);
      }

      async function handleReviewGrade(approve) {
        const id = Number(document.getElementById("grade-review-id").value);
        const comment = document.getElementById("grade-review-comment").value.trim() || undefined;
        const statusEl = document.getElementById("grade-review-status");
        if (!id) {
          statusEl.textContent = "请输入 grade_id";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/grades/review", {
            method: "POST",
            body: JSON.stringify({ grade_id: id, approve, comment }),
          });
          statusEl.textContent = `已更新状态：${res.status}`;
          statusEl.style.color = "var(--muted)";
          loadGradesAdmin();
          loadStudentData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handlePublishGrades() {
        const courseId = Number(document.getElementById("grade-publish-course").value);
        const reviewer = document.getElementById("grade-publish-reviewer").value.trim() || undefined;
        const statusEl = document.getElementById("grade-publish-status");
        if (!courseId) {
          statusEl.textContent = "请输入 course_id";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/grades/publish", {
            method: "POST",
            body: JSON.stringify({ course_id: courseId, reviewer }),
          });
          statusEl.textContent = `发布成功，数量：${res.published}`;
          statusEl.style.color = "var(--muted)";
          loadGradesAdmin();
          loadStudentData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleFilterStudents() {
        const q = document.getElementById("student-search").value.trim();
        const classId = document.getElementById("student-class-filter").value;
        const qs = [];
        if (q) qs.push(`q=${encodeURIComponent(q)}`);
        if (classId) qs.push(`class_id=${classId}`);
        const list = await authFetch(`/api/students${qs.length ? "?" + qs.join("&") : ""}`);
        renderStudents(list);
      }

      async function loadAdminData() {
        if (!currentRoles.includes("ADMIN")) return;
        const [students, plans, majors, classes, courses, exams, terms] = await Promise.all([
          authFetch("/api/students"),
          authFetch("/api/training-plans"),
          authFetch("/api/majors"),
          authFetch("/api/classes"),
          authFetch("/api/courses"),
          authFetch("/api/exams"),
          authFetch("/api/terms"),
        ]);
        renderStudents(students);
        renderPlans(plans);
        renderMajors(majors);
        renderClasses(classes);
        renderCourses(courses);
        renderExams(exams, "admin-exams");
        renderTerms(terms);
      }

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password) {
          setStatus("请输入用户名和密码", true);
          return;
        }
        setStatus("登录中...");
        try {
          const resp = await fetch(apiBase + "/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || "登录失败");
          }
          const data = await resp.json();
          token = data.access_token;
          currentRoles = data.roles || [];
          loginScreen.classList.add("hidden");
          appShell.classList.remove("hidden");
          document.getElementById("welcome-title").textContent = `欢迎，${data.user.full_name}`;
          document.getElementById("welcome-roles").textContent = `角色：${currentRoles.join(" / ")}`;
          document.getElementById("welcome-roles-top").textContent = currentRoles.join(" / ");
          const menuResp = await authFetch("/api/menus");
          renderMenus(menuResp.menus);
          updateVisibleBlocks();
          loadDashboard();
          loadStudentData();
          loadTeacherData();
          loadAdminData();
          setStatus("");
        } catch (err) {
          setStatus(err.message, true);
        }
      });

      document.getElementById("fill-student").addEventListener("click", () => {
        document.getElementById("username").value = "student1";
        document.getElementById("password").value = "student123";
      });
      document.getElementById("fill-teacher").addEventListener("click", () => {
        document.getElementById("username").value = "teacher1";
        document.getElementById("password").value = "teacher123";
      });
      document.getElementById("fill-admin").addEventListener("click", () => {
        document.getElementById("username").value = "admin";
        document.getElementById("password").value = "admin123";
      });

      document.getElementById("logout-btn").addEventListener("click", () => {
        token = null;
        currentRoles = [];
        appShell.classList.add("hidden");
        loginScreen.classList.remove("hidden");
      });

      async function handleCreateClass() {
        const payload = {
          code: document.getElementById("class-code").value.trim(),
          name: document.getElementById("class-name").value.trim(),
          major_id: Number(document.getElementById("class-major").value),
          term_id: Number(document.getElementById("class-term").value),
          grade_year: document.getElementById("class-grade").value
            ? Number(document.getElementById("class-grade").value)
            : undefined,
        };
        const statusEl = document.getElementById("create-class-status");
        try {
          const res = await authFetch("/api/classes", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `班级创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleCreateCourse() {
        const payload = {
          code: document.getElementById("course-code").value.trim(),
          name: document.getElementById("course-name").value.trim(),
          major_id: Number(document.getElementById("course-major").value),
          term_id: Number(document.getElementById("course-term").value),
          teacher_id: document.getElementById("course-teacher").value
            ? Number(document.getElementById("course-teacher").value)
            : undefined,
          class_id: document.getElementById("course-class").value
            ? Number(document.getElementById("course-class").value)
            : undefined,
          course_type: document.getElementById("course-type").value || undefined,
        };
        const statusEl = document.getElementById("create-course-status");
        try {
          const res = await authFetch("/api/courses", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `课程创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleCreatePlan() {
        const statusEl = document.getElementById("create-plan-status");
        const courses = document
          .getElementById("plan-courses")
          .value.split(",")
          .map((v) => Number(v.trim()))
          .filter(Boolean);
        const payload = {
          name: document.getElementById("plan-name").value.trim(),
          entry_year: Number(document.getElementById("plan-entry").value),
          major_id: Number(document.getElementById("plan-major").value),
          item_course_ids: courses,
        };
        try {
          const res = await authFetch("/api/training-plans", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `方案创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleScheduleCreate() {
        const statusEl = document.getElementById("create-schedule-status");
        const payload = {
          course_id: Number(document.getElementById("sched-course").value),
          class_id: document.getElementById("sched-class").value
            ? Number(document.getElementById("sched-class").value)
            : undefined,
          teacher_id: document.getElementById("sched-teacher").value
            ? Number(document.getElementById("sched-teacher").value)
            : undefined,
          weekday: Number(document.getElementById("sched-weekday").value),
          start_slot: Number(document.getElementById("sched-start").value),
          end_slot: Number(document.getElementById("sched-end").value),
          location: document.getElementById("sched-location").value || undefined,
        };
        try {
          const res = await authFetch("/api/schedule", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `排课成功：ID ${res.id}`;
          statusEl.style.color = "var(--muted)";
          loadStudentData();
          loadTeacherData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleImportStudents() {
        const statusEl = document.getElementById("import-students-status");
        let data;
        try {
          data = JSON.parse(document.getElementById("import-students-input").value || "[]");
        } catch (e) {
          statusEl.textContent = "JSON 格式错误";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/students/import", {
            method: "POST",
            body: JSON.stringify({ students: data }),
          });
          statusEl.textContent = `导入完成：成功 ${res.created}，跳过 ${res.skipped}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleImportGrades() {
        const statusEl = document.getElementById("import-grades-status");
        let data;
        try {
          data = JSON.parse(document.getElementById("import-grades-input").value || "[]");
        } catch (e) {
          statusEl.textContent = "JSON 格式错误";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/grades/import", {
            method: "POST",
            body: JSON.stringify({ grades: data }),
          });
          statusEl.textContent = `导入完成：新增 ${res.inserted}，更新 ${res.updated}`;
          statusEl.style.color = "var(--muted)";
          loadGradesAdmin();
          loadStudentData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleCreateTerm() {
        const statusEl = document.getElementById("create-term-status");
        const payload = {
          name: document.getElementById("term-name").value.trim(),
          start_date: document.getElementById("term-start").value || undefined,
          end_date: document.getElementById("term-end").value || undefined,
          is_current: document.getElementById("term-current").checked,
        };
        if (!payload.name) {
          statusEl.textContent = "名称必填";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/terms", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleUpdateTerm() {
        const statusEl = document.getElementById("update-term-status");
        const id = Number(document.getElementById("term-edit-id").value);
        if (!id) {
          statusEl.textContent = "请填写 term_id";
          statusEl.style.color = "#c36a00";
          return;
        }
        const payload = {
          name: document.getElementById("term-edit-name").value.trim() || undefined,
          start_date: document.getElementById("term-edit-start").value || undefined,
          end_date: document.getElementById("term-edit-end").value || undefined,
        };
        const editCurrent = document.getElementById("term-edit-current");
        if (!editCurrent.indeterminate) {
          payload.is_current = editCurrent.checked;
        }
        const cleanPayload = Object.fromEntries(
          Object.entries(payload).filter(([, v]) => v !== undefined && v !== "")
        );
        if (Object.keys(cleanPayload).length === 0) {
          statusEl.textContent = "请至少填写一个字段";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch(`/api/terms/${id}`, {
            method: "PUT",
            body: JSON.stringify(cleanPayload),
          });
          statusEl.textContent = `更新成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleExportGrades() {
        const statusEl = document.getElementById("export-grades-status");
        const courseId = document.getElementById("export-grade-course").value;
        const classId = document.getElementById("export-grade-class").value;
        const qs = [];
        if (courseId) qs.push(`course_id=${courseId}`);
        if (classId) qs.push(`class_id=${classId}`);
        try {
          const list = await authFetch(`/api/grades/export${qs.length ? "?" + qs.join("&") : ""}`);
          statusEl.textContent = `导出 ${list.length} 条（控制台查看 JSON）`;
          statusEl.style.color = "var(--muted)";
          console.log("导出成绩", list);
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleCreateExam() {
        const statusEl = document.getElementById("create-exam-status");
        const payload = {
          course_id: Number(document.getElementById("exam-course").value),
          class_id: document.getElementById("exam-class").value
            ? Number(document.getElementById("exam-class").value)
            : undefined,
          term_id: document.getElementById("exam-term").value
            ? Number(document.getElementById("exam-term").value)
            : undefined,
          exam_type: document.getElementById("exam-type").value || undefined,
          exam_date: document.getElementById("exam-date").value || undefined,
          start_time: document.getElementById("exam-start").value || undefined,
          duration_minutes: document.getElementById("exam-duration").value
            ? Number(document.getElementById("exam-duration").value)
            : undefined,
          location: document.getElementById("exam-location").value || undefined,
          invigilators: document.getElementById("exam-invigilators").value || undefined,
        };
        if (!payload.course_id) {
          statusEl.textContent = "请填写 course_id";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/exams", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `创建成功：${res.exam_type || ""} ${res.id}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
          loadStudentData();
          loadTeacherData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleCreateMajor() {
        const statusEl = document.getElementById("create-major-status");
        const payload = {
          code: document.getElementById("major-code").value.trim(),
          name: document.getElementById("major-name").value.trim(),
          level: document.getElementById("major-level").value.trim() || undefined,
          degree: document.getElementById("major-degree").value.trim() || undefined,
          duration_years: document.getElementById("major-duration").value
            ? Number(document.getElementById("major-duration").value)
            : undefined,
          org_unit_id: document.getElementById("major-org").value
            ? Number(document.getElementById("major-org").value)
            : undefined,
          parent_id: document.getElementById("major-parent").value
            ? Number(document.getElementById("major-parent").value)
            : undefined,
          description: document.getElementById("major-desc").value.trim() || undefined,
          active: document.getElementById("major-active").checked,
        };
        if (!payload.code || !payload.name) {
          statusEl.textContent = "编码/名称必填";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch("/api/majors", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          statusEl.textContent = `创建成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      async function handleUpdateMajor() {
        const statusEl = document.getElementById("update-major-status");
        const id = Number(document.getElementById("major-edit-id").value);
        if (!id) {
          statusEl.textContent = "请填写 major_id";
          statusEl.style.color = "#c36a00";
          return;
        }
        const activeEl = document.getElementById("major-edit-active");
        const payload = {
          name: document.getElementById("major-edit-name").value.trim() || undefined,
          level: document.getElementById("major-edit-level").value.trim() || undefined,
          degree: document.getElementById("major-edit-degree").value.trim() || undefined,
          duration_years: document.getElementById("major-edit-duration").value
            ? Number(document.getElementById("major-edit-duration").value)
            : undefined,
          org_unit_id: document.getElementById("major-edit-org").value
            ? Number(document.getElementById("major-edit-org").value)
            : undefined,
          parent_id: document.getElementById("major-edit-parent").value
            ? Number(document.getElementById("major-edit-parent").value)
            : undefined,
          description: document.getElementById("major-edit-desc").value.trim() || undefined,
        };
        if (!activeEl.indeterminate) {
          payload.active = activeEl.checked;
        }
        const cleanPayload = Object.fromEntries(
          Object.entries(payload).filter(([, v]) => v !== undefined && v !== "")
        );
        if (Object.keys(cleanPayload).length === 0) {
          statusEl.textContent = "请至少填写一个字段";
          statusEl.style.color = "#c36a00";
          return;
        }
        try {
          const res = await authFetch(`/api/majors/${id}`, {
            method: "PUT",
            body: JSON.stringify(cleanPayload),
          });
          statusEl.textContent = `更新成功：${res.name}`;
          statusEl.style.color = "var(--muted)";
          loadAdminData();
        } catch (err) {
          statusEl.textContent = err.message;
          statusEl.style.color = "#c36a00";
        }
      }

      // 绑定按钮事件
      document.getElementById("create-class-btn").addEventListener("click", handleCreateClass);
      document.getElementById("create-course-btn").addEventListener("click", handleCreateCourse);
      document.getElementById("create-plan-btn").addEventListener("click", handleCreatePlan);
      document.getElementById("create-schedule-btn").addEventListener("click", handleScheduleCreate);
      document.getElementById("import-students-btn").addEventListener("click", handleImportStudents);
      document.getElementById("create-major-btn").addEventListener("click", handleCreateMajor);
      document.getElementById("update-major-btn").addEventListener("click", handleUpdateMajor);
      document.getElementById("filter-students-btn").addEventListener("click", handleFilterStudents);
      document.getElementById("load-schedule-btn").addEventListener("click", loadScheduleAdmin);
      document.getElementById("load-grades-btn").addEventListener("click", loadGradesAdmin);
      document.getElementById("approve-grade-btn").addEventListener("click", () => handleReviewGrade(true));
      document.getElementById("reject-grade-btn").addEventListener("click", () => handleReviewGrade(false));
      document.getElementById("publish-grades-btn").addEventListener("click", handlePublishGrades);
      document.getElementById("import-grades-btn").addEventListener("click", handleImportGrades);
      document.getElementById("export-grades-btn").addEventListener("click", handleExportGrades);
      document.getElementById("create-exam-btn").addEventListener("click", handleCreateExam);
      document.getElementById("create-term-btn").addEventListener("click", handleCreateTerm);
      document.getElementById("update-term-btn").addEventListener("click", handleUpdateTerm);

      // 默认编辑“启用”复选框为不改状态（半选）
      const majorEditActive = document.getElementById("major-edit-active");
      if (majorEditActive) {
        majorEditActive.indeterminate = true;
        majorEditActive.addEventListener("change", () => {
          majorEditActive.indeterminate = false;
        });
      }
    </script>
  </body>
</html>
      const termEditCurrent = document.getElementById("term-edit-current");
      if (termEditCurrent) {
        termEditCurrent.indeterminate = true;
        termEditCurrent.addEventListener("change", () => {
          termEditCurrent.indeterminate = false;
        });
      }
